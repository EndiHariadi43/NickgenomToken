name: Roadmap Auto Check

on:
  workflow_run:
    workflows:
      - "Verify on BscScan"
      - "Whitepaper release"
    types: [completed]

  workflow_dispatch:
    inputs:
      key:
        description: "ROADMAP key to check"
        required: true
        default: "VERIFY"
        type: choice
        options:
          - VERIFY
          - WHITEPAPER
          - WEBSITE
          - LIQ
          - AIRDROP
          - LISTINGS
          - QUESTS
          - STAKING
          - AI
          - PARTNERS
          - BURN
          - CEX
          - COMMUNITY

permissions:
  contents: write

jobs:
  update-roadmap:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Decide ROADMAP key
        id: key
        shell: bash
        run: |
          KEY=""
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            case "${{ github.event.workflow_run.name }}" in
              "Verify on BscScan") KEY="VERIFY" ;;
              "Whitepaper release") KEY="WHITEPAPER" ;;
            esac
          else
            KEY="${{ inputs.key }}"
          fi
          echo "key=$KEY" >> "$GITHUB_OUTPUT"

      - name: Normalize legacy lines (✅ → [x])
        shell: bash
        run: |
          for f in README.md docs/Whitepaper.md; do
            [ -f "$f" ] || continue
            sed -i -E 's/^([[:space:]]*-[[:space:]]*)✅[[:space:]]/\1[x] /g' "$f"
          done

      - name: Update README and Whitepaper (use green badge)
        if: steps.key.outputs.key != ''
        shell: bash
        run: |
          set -e
          KEY="${{ steps.key.outputs.key }}"
          DATE="$(date +'%Y-%m-%d')"
          # Shields.io butuh double-hyphen untuk menampilkan '-' literal
          DATE_SHIELDS="${DATE//-/"--"}"
          BADGE="![done ${DATE}](https://img.shields.io/badge/done-${DATE_SHIELDS}-brightgreen?style=flat-square)"

          mark_done () {
            FILE="$1"
            MARK="<!-- ROADMAP:${KEY} -->"
            [ -f "$FILE" ] || return 0

            # 1) Centang task list & tambahkan badge jika belum ada
            awk -v key="$MARK" -v badge="$BADGE" '
            {
              if ($0 ~ key) {
                # unchecked: "- [ ] ..." -> "- [x] ..." + badge (kalau belum ada)
                if ($0 ~ /^[[:space:]]*-[[:space:]]*\[[[:space:]]\][[:space:]]/) {
                  sub(/\[[[:space:]]\]/, "[x]")
                  if ($0 !~ /img\.shields\.io\/badge\/done-/) { $0 = $0 " " badge }
                }
                # already checked: pastikan ada badge
                else if ($0 ~ /^[[:space:]]*-[[:space:]]*\[x\][[:space:]]/ && $0 !~ /img\.shields\.io\/badge\/done-/) {
                  $0 = $0 " " badge
                }
              }
              print
            }' "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"

            # 2) Ganti pola lama "(done YYYY-MM-DD)" menjadi badge hijau
            sed -i -E "s/\(done[[:space:]]+[0-9]{4}-[0-9]{2}-[0-9]{2}\)/ ${BADGE//\//\\/}/g" "$FILE"
          }

          mark_done "README.md"
          mark_done "docs/Whitepaper.md"

          if git status --porcelain | grep -E "README\.md|docs/Whitepaper\.md" >/dev/null; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md docs/Whitepaper.md
            git commit -m "chore(roadmap): mark $KEY with green badge on $DATE"
            git push
          else
            echo "No roadmap changes to commit."
          fi
